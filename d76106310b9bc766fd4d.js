import"./style.css";import*as THREE from"three";import{PointerLockControls}from"three/examples/jsm/controls/PointerLockControls";import{GLTFLoader}from"three/examples/jsm/loaders/GLTFLoader.js";import{addCrossHair}from"../controls/CrossHair.js";let camera,scene,renderer,controls;const objects=[];let raycaster,currentIntersect=null,moveForward=!1,moveBackward=!1,moveLeft=!1,moveRight=!1,canJump=!1,mixer=null,prevTime=performance.now();const velocity=new THREE.Vector3,direction=new THREE.Vector3,vertex=new THREE.Vector3,color=new THREE.Color,blocker=document.getElementById("blocker"),instructions2=document.getElementById("instructions2"),description=document.getElementById("description"),description2=document.getElementById("description2"),description3=document.getElementById("description3"),overlayUi=document.getElementById("overlay1");let toggledescription=!1,toggledescription2=!1,toggledescription3=!1;const clock=new THREE.Clock;let previousTime=0,gateOpen=!1;const parameters={count:1e5,size:.01,radius:5,branches:3,spin:1,randomness:.2,randomnessPower:3,insideColor:"#ff6030",outsideColor:"#1b3984"};let geometry=null,material2=null,points=null;const mouse=new THREE.Vector2;function init(){camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e3),camera.position.y=10,camera.position.z=140,camera.position.x=10,addCrossHair(camera);const e=new THREE.AudioListener;camera.add(e);const o=new THREE.Audio(e);(new THREE.AudioLoader).load("../video/ambient.ogg",(function(e){o.setBuffer(e),o.setLoop(!0),o.setVolume(.5)})),scene=new THREE.Scene,scene.background=new THREE.Color(0),scene.fog=new THREE.Fog(16777215,0,750);const t=(new THREE.TextureLoader).load("../video/Poster.png"),n=new THREE.HemisphereLight(15658751,7829384,1);n.position.set(0,.5,2),scene.add(n),controls=new PointerLockControls(camera,document.body),window.addEventListener("click",(()=>{currentIntersect&&(console.log("click"),controls.unlock(),currentIntersect=null,dontdisplayUi())})),instructions2.addEventListener("click",(function(){controls.lock(),l.play(),p.play(),y.play(),o.play(),console.log("OpenGate."),gateOpen=!0})),description.addEventListener("click",(function(){controls.lock()})),description2.addEventListener("click",(function(){controls.lock()})),description3.addEventListener("click",(function(){controls.lock()})),controls.addEventListener("lock",(function(){instructions2.style.display="none",description.style.display="none",description2.style.display="none",description3.style.display="none",blocker.style.display="none"})),controls.addEventListener("unlock",(function(){1==toggledescription?(blocker.style.display="block",instructions2.style.display="none",description.style.display="flex",description2.style.display="none",description3.style.display="none",console.log("displaydescription")):1==toggledescription2?(blocker.style.display="block",instructions2.style.display="none",description.style.display="none",description2.style.display="flex",description3.style.display="none",console.log("displaydescription2")):1==toggledescription3?(blocker.style.display="block",instructions2.style.display="none",description.style.display="none",description2.style.display="none",description3.style.display="flex",console.log("displaydescription3")):0==toggledescription&&0==toggledescription2&&0==toggledescription3&&(blocker.style.display="block",instructions2.style.display="flex",description.style.display="none",description2.style.display="none",description3.style.display="none",dontdisplayUi(),console.log("displayinstruction"))})),scene.add(controls.getObject()),document.addEventListener("touchstart",(function(){console.log("touch"),moveForward=!0})),document.addEventListener("touchend",(function(){console.log("end"),moveForward=!1})),document.addEventListener("keydown",(function(e){switch(e.code){case"ArrowUp":case"KeyW":moveForward=!0;break;case"ArrowLeft":case"KeyA":moveLeft=!0;break;case"ArrowDown":case"KeyS":moveBackward=!0;break;case"ArrowRight":case"KeyD":moveRight=!0;break;case"Space":!0===canJump&&(velocity.y+=350),canJump=!1}}),!1),document.addEventListener("keyup",(function(e){switch(e.code){case"ArrowUp":case"KeyW":moveForward=!1;break;case"ArrowLeft":case"KeyA":moveLeft=!1;break;case"ArrowDown":case"KeyS":moveBackward=!1;break;case"ArrowRight":case"KeyD":moveRight=!1}}),!1),raycaster=new THREE.Raycaster;let i=new THREE.PlaneGeometry(2e3,2e3,100,100);i.rotateX(-Math.PI/2);let s=i.attributes.position;for(let e=0,o=s.count;e<o;e++)vertex.fromBufferAttribute(s,e),vertex.x+=20*Math.random()-10,vertex.y+=2*Math.random(),vertex.z+=20*Math.random()-10,s.setXYZ(e,vertex.x,vertex.y,vertex.z);i=i.toNonIndexed(),s=i.attributes.position;const r=[];for(let e=0,o=s.count;e<o;e++)color.setHSL(.3*Math.random()+.5,.75,.25*Math.random()+.75),r.push(color.r,color.g,color.b);i.setAttribute("color",new THREE.Float32BufferAttribute(r,3));const a=new THREE.MeshBasicMaterial({wireframe:!0}),c=new THREE.Mesh(i,a);scene.add(c);const l=document.getElementById("video1"),d=new THREE.VideoTexture(l);l.src="../video/movie.mp4";const p=document.getElementById("video2"),m=new THREE.VideoTexture(p);p.src="../video/movie2.mp4";const y=document.getElementById("video3"),E=new THREE.VideoTexture(y);y.src="../video/movie3.mp4";const w=new THREE.PlaneGeometry(40,20),u=new THREE.PlaneGeometry(20,40),g=new THREE.MeshBasicMaterial({map:d,side:THREE.DoubleSide,toneMapped:!1}),h=new THREE.MeshBasicMaterial({map:m,side:THREE.DoubleSide,toneMapped:!1}),v=new THREE.MeshBasicMaterial({map:E,side:THREE.DoubleSide,toneMapped:!1}),R=new THREE.MeshBasicMaterial({map:t,side:THREE.DoubleSide,toneMapped:!1}),T=new THREE.Mesh(w,g);T.position.z=-330,T.position.y=15,T.position.x=-5;const H=new THREE.Mesh(w,h);H.position.z=-305,H.position.y=15,H.position.x=-45,H.rotation.y=70;const x=new THREE.Mesh(w,v);x.position.z=-305,x.position.y=15,x.position.x=45,x.rotation.y=-70;const M=new THREE.Mesh(w,g);M.position.z=-200,M.position.y=15,M.position.x=0;const f=new THREE.Mesh(w,h);f.position.z=-220,f.position.y=15,f.position.x=-45,f.rotation.y=-70;const b=new THREE.Mesh(w,v);b.position.z=-220,b.position.y=15,b.position.x=45,b.rotation.y=70;const k=new THREE.Mesh(w,g);k.position.z=-40,k.position.y=15,k.position.x=10;const z=new THREE.Mesh(u,R);z.position.z=20,z.position.y=25,z.position.x=10;const L=new THREE.BoxGeometry(20,10,10),B=new THREE.BoxGeometry(20,1,10),A=new THREE.MeshBasicMaterial({color:4095,opacity:0,transparent:!0}),C=new THREE.MeshBasicMaterial({color:8569262,wireframe:!0}),F=new THREE.MeshBasicMaterial({opacity:.2,transparent:!0,wireframe:!0}),I=new THREE.Mesh(L,A);I.position.y=8,I.position.z=-340,I.position.x=-5,I.name="box";const P=new THREE.Mesh(B,C);P.position.y=2,P.position.z=-340,P.position.x=-5;const U=new THREE.Mesh(L,A);U.position.z=-315,U.position.y=8,U.position.x=55,U.rotation.y=-70,U.name="box2";const W=new THREE.Mesh(B,C);W.position.z=-315,W.position.y=2,W.position.x=55,W.rotation.y=-70;const j=new THREE.Mesh(L,A);j.position.z=-315,j.position.y=8,j.position.x=-55,j.rotation.y=70,j.name="box3";const G=new THREE.Mesh(B,C);G.position.z=-315,G.position.y=2,G.position.x=-55,G.rotation.y=70;const S=new THREE.Mesh(L,A);S.position.y=8,S.position.z=-190,S.position.x=0,S.name="box4";const O=new THREE.Mesh(B,C);O.position.y=2,O.position.z=-190,O.position.x=0;const D=new THREE.Mesh(L,A);D.position.z=-210,D.position.y=8,D.position.x=50,D.rotation.y=70,D.name="box5";const K=new THREE.Mesh(B,C);K.position.z=-210,K.position.y=2,K.position.x=50,K.rotation.y=70;const V=new THREE.Mesh(L,A);V.position.z=-210,V.position.y=8,V.position.x=-50,V.rotation.y=-70,V.name="box6";const N=new THREE.Mesh(B,C);N.position.z=-210,N.position.y=2,N.position.x=-50,N.rotation.y=-70,geometry=new THREE.BufferGeometry;const J=new Float32Array(3*parameters.count),X=new Float32Array(3*parameters.count),Y=new THREE.Color(parameters.insideColor),q=new THREE.Color(parameters.outsideColor);for(let e=0;e<parameters.count;e++){const o=3*e,t=Math.random()*parameters.radius,n=t*parameters.spin,i=e%parameters.branches/parameters.branches*Math.PI*2,s=Math.pow(Math.random(),parameters.randomnessPower)*(Math.random()<.5?1:-1)*parameters.randomness*t,r=Math.pow(Math.random(),parameters.randomnessPower)*(Math.random()<.5?1:-1)*parameters.randomness*t,a=Math.pow(Math.random(),parameters.randomnessPower)*(Math.random()<.5?1:-1)*parameters.randomness*t;J[o]=Math.cos(i+n)*t+s,J[o+1]=r,J[o+2]=Math.sin(i+n)*t+a;const c=Y.clone();c.lerp(q,t/parameters.radius),X[o]=c.r,X[o+1]=c.g,X[o+2]=c.b}geometry.setAttribute("position",new THREE.BufferAttribute(J,3)),geometry.setAttribute("color",new THREE.BufferAttribute(X,3)),material2=new THREE.PointsMaterial({size:parameters.size,sizeAttenuation:!0,depthWrite:!1,blending:THREE.AdditiveBlending,vertexColors:!0}),points=new THREE.Points(geometry,material2),points.position.y=160,points.position.z=-250,points.scale.x=300,points.scale.y=300,points.scale.z=300,console.log("generate the galaxy"),scene.add(T,H,x,M,f,b,k,z,I,U,j,S,D,V,P,W,G,O,K,N,points),objects.push(I,U,j,S,D,V),l.loop=!0,p.loop=!0,y.loop=!0;const Z=new GLTFLoader;Z.load("../models/braindead.glb",(function(e){const o=e.scene;o.scale.set(1.5,1.5,1.5),o.position.set(-25,40,-350),o.rotation.set(0,-80,0),o.traverse((e=>{e.isMesh&&(e.material=F)})),scene.add(o)}),(function(e){console.log(e.loaded/e.total*100+"% loaded")}),(function(e){console.log("An error happened")})),Z.load("../models/gateanimated2.glb",(function(e){const o=e.scene;o.scale.set(15,15,15),o.position.set(10,0,70),o.rotation.set(0,-139.75,0),o.traverse((e=>{e.isMesh&&(e.material.wireframe=!0)})),scene.add(o),mixer=new THREE.AnimationMixer(e.scene);const t=mixer.clipAction(e.animations[1]),n=mixer.clipAction(e.animations[0]);t.clampWhenFinished=!0,t.setLoop(THREE.LoopOnce),t.play(),n.clampWhenFinished=!0,n.setLoop(THREE.LoopOnce),n.play()}),(function(e){console.log(e.loaded/e.total*100+"% loaded")}),(function(e){console.log("An error happened")})),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(renderer.domElement),window.addEventListener("resize",onWindowResize)}function displayUi(){console.log("displayUi"),overlayUi.style.display="flex"}function dontdisplayUi(){console.log("dontdisplayUi"),overlayUi.style.display="none"}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function animate(){requestAnimationFrame(animate);const e=performance.now(),o=clock.getElapsedTime(),t=o-previousTime;if(previousTime=o,1==gateOpen&&mixer&&mixer.update(t),!0===controls.isLocked){raycaster.setFromCamera(mouse,camera);const o=raycaster.intersectObjects(objects);if(o.length>0)for(var n=0;n<o.length;n++)o[n].object.name,currentIntersect||(displayUi(),toggledescription=!0,toggledescription2=!1,toggledescription3=!1,console.log("box"),console.log("mouse enter")),currentIntersect=o[0];else currentIntersect&&(console.log("leave"),dontdisplayUi(),blocker.style.display="none",instructions2.style.display="none",description.style.display="none",description2.style.display="none",description3.style.display="none",toggledescription=!1,toggledescription2=!1,toggledescription3=!1),currentIntersect=null;const t=(e-prevTime)/1e3;velocity.x-=10*velocity.x*t,velocity.z-=10*velocity.z*t,direction.z=Number(moveForward)-Number(moveBackward),direction.x=Number(moveRight)-Number(moveLeft),direction.normalize(),(moveForward||moveBackward)&&(velocity.z-=400*direction.z*t),(moveLeft||moveRight)&&(velocity.x-=400*direction.x*t),controls.moveRight(-velocity.x*t),controls.moveForward(-velocity.z*t),controls.getObject().position.y+=velocity.y*t}prevTime=e,renderer.render(scene,camera)}document.addEventListener("movemouse",(()=>{mouse.x=MouseEvent.clientX/window.innerWidth*2-1,mouse.y=MouseEvent.clientY/window.innerHeight*2+1})),init(),animate();